{% extends 'template.html' %}
{% load bootstrap5 %}
{% load static %}
{% block nav %}
{% include 'nav_estagio.html' %}
{% endblock %}
{% block css %} {% endblock %}
{% block main %}
<div class="d-flex flex-wrap">        
    <h1 id="go">Vaga de estágio</h1>   
    <a href="{% url 'estagio:vagas' %}" class="btn btn-secondary ms-auto my-auto">
        Voltar
    </a>          
  </div>
  {% if forms_vaga.errors.vaga %}
                <div class="text-white bg-danger text-center rounded mt-3  py-3">
                    {{forms_vaga.vaga.errors}}
                    <!-- O seu curso não corresponde com o da vaga! Tente outro. -->
                </div>
                {% endif %}
       <div class="row mb-5">
        <div class="col pt-4 pe-5">
            <h2 class="">{{vaga.nome}}</h2>
            <div class="w-100 d-flex">
                {% if vaga.img2 %}
                <img style="border-radius: 30px;" class="img-fluid mx-auto" src="{{vaga.img2.url}}" alt="">
                {% endif %}
            </div>
            <p style="text-indent: 40px;" class="text-secondary text-justify mt-4"><i>{{vaga.descricao}}</i></p>
            
        </div>
        <div class="col-sm-4 pt-5 col-12 mx-auto">
            <form method="POST">                
                {% csrf_token %}
                <div class="row">
                    <div class="col">
                        {% bootstrap_form forms_estudante %}
                    </div>
                </div>
                <div class="row">
                    <div class="col d-flex flex-column">
                        {% bootstrap_form forms_vaga %}
                        <small class="mx-auto mb-3 text-danger w-100 text-center" id="checkResponse"></small>

                        <div class="mb-3">
                        <label class="form-label" for="id_local_do_estagio_de_pretensao">Local de pretensão do estágio</label>
                            <select name="local_do_estagio_de_pretensao" class="mb-3 form-select" title="" id="id_local_do_estagio_de_pretensao">
                                <option value="" selected>---------</option> 
                                {% for local in vaga.locais.all %}
                                <option value="{{local.id}}">{{local.secretaria}} - {{local.local}}</option>   
                                {% endfor %}                   
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <button type="submit" class="btn btn-primary w-100">
                            Candidatar-se
                        </button>                       
                    </div>
                </div>
               </form>
        </div>
       </div>
<style>
    li{
        list-style: none;
    }
    .nonfield{
        display: none;
    }
    .form-control{
        border-radius: 10px !important;
    }
    .form-select{
        border-radius: 10px !important;
    }
</style>
<script>
    cursos=[
        {% for curso in vaga.curso.all %}
        
            '{{curso.nome}}',
        {% endfor %}
    ]
    curso_atual = '{{forms_estudante.curso.value}}'

    function get_cursos(id){
        const csrfToken = getCsrfToken();
        fetch('/estagio/getCursos/'+id+'/',{
            method: 'GET',
            headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                }
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById('id_curso').innerHTML = data;
        })
        .catch(error => {
                console.error('Erro ao obter locais:', error);
        })
    }
    function getCsrfToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            return csrfToken;
        }
    function checkVaga(selectElement){
        var selectedIndex = selectElement.selectedIndex;
        var selectedText = selectElement.options[selectedIndex].text;
        console.log(selectedText)
        console.log(cursos.includes(selectedText))
        if(cursos.includes(selectedText)){
            document.getElementById('checkResponse').innerHTML = '';
            document.querySelector('button[type="submit"]').disabled = false;
        }else{
            document.getElementById('checkResponse').innerHTML = 'O seu curso não corresponde com o da vaga! Tente outro.';
            document.querySelector('button[type="submit"]').disabled = true;
        }
    }
    // quero que o campo universidade caso seja difretente de '---------' rode a funcao get_cursos
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('s-vagas').classList.add('s-nav-active');
        var universidadeSelect = document.getElementById('id_universidade'); // Substitua pelo ID correto do elemento
        var selectedValue = universidadeSelect.value;
        
        if (selectedValue !== '---------' && selectedValue !== '') {
            get_cursos(selectedValue);
        }else{
            document.getElementById('id_curso').innerHTML = '<option value="" selected>---------</option>';
        }
       
    })

 

</script>
{% endblock %}
{% block footer %}
{% include 'instagram_desenvolve.html' %}
{% endblock %}